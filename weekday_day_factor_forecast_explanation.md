# weekday_day_factor_forecast.py 代码逻辑说明

本脚本用于利用 2014-03-01 至 2014-08-31 的资金申购与赎回数据，分析 weekday（星期几）和 day（每月几号）两个周期因子的影响，并基于这两个因子对 2014-09-01 至 2014-09-30 的申购和赎回金额进行预测。

## 主要步骤

1. **数据读取与预处理**
   - 读取 `user_balance_table.csv` 文件中的 `report_date`, `total_purchase_amt`, `total_redeem_amt` 三列。
   - 将 `report_date` 转换为 pandas 的日期类型。

2. **筛选训练区间**
   - 选取 2014-03-01 至 2014-08-31 作为训练数据。
   - 按日期聚合，得到每日的申购和赎回总额。

3. **添加周期因子**
   - 计算每一天对应的星期几（0=周一，6=周日），记为 `weekday`。
   - 计算每一天在当月的日期（1-31），记为 `day`。

4. **计算均值因子**
   - 计算训练区间内申购和赎回金额的全局均值。
   - 计算不同 `weekday` 下的申购和赎回均值（即一周内每天的平均值）。
   - 计算不同 `day` 下的申购和赎回均值（即每月1号、2号……31号的平均值）。

5. **预测 2014-09-01 至 2014-09-30**
   - 对于 2014-09-01 至 2014-09-30 的每一天：
     - 获取其 `weekday` 和 `day`。
     - 预测值 = weekday因子均值 + day因子均值 - 历史全局均值（避免重复计入均值）。
     - 这样分别得到申购和赎回的预测值。

6. **结果保存**
   - 将预测结果保存为 `weekday_day_factor_forecast_09.csv`，格式为 `report_date,purchase,redeem`，无表头。

## 方法原理与实现动机

### 为什么要采用 weekday 和 day 因子？
- **周期性假设**：金融市场、用户行为等常常存在明显的周期性。例如：
  - 每周的不同天（如周一、周五）资金流动模式不同。
  - 每月初、月中、月末，或特定日期（如工资发放日、还款日）资金流动也有规律。
- **数据驱动**：通过历史数据可以直接观测到 weekday 和 day 对申购/赎回的影响。

### 为什么用“weekday因子 + day因子 - 历史均值”？
- **分解思想**：
  - 申购/赎回金额 = 总体均值 + weekday效应 + day效应 + 其它噪声。
  - 但直接相加会重复计入均值，因此用 weekday均值 + day均值 - 历史均值，等价于“去均值后再叠加”。
- **避免重复计入**：
  - 如果直接相加，均值部分会被重复统计两次。
  - 减去历史均值后，得到的预测值更贴近真实的周期性波动。

### 这种方法的假设
- **线性可加性**：假设 weekday 和 day 的影响是线性且独立可加的。
- **稳定性**：假设周期性规律在未来一个月内不会发生突变。
- **无交互项**：未考虑 weekday 和 day 的交互效应（如“每月第一个周一”是否有特殊性）。

### 优点
- **简单直观**：实现和理解都很简单，无需复杂建模。
- **可解释性强**：可以清楚看到每个周期因子的贡献。
- **对小样本友好**：不需要大量数据即可拟合。

### 局限性
- **忽略趋势和突发事件**：无法捕捉长期趋势、突发政策、节假日等影响。
- **未建模交互项**：如“月初的周一”特殊效应未被捕捉。
- **对异常值敏感**：均值受极端值影响较大。

### 适用场景
- 主要用于周期性强、趋势性弱、无重大突发事件的短期预测。
- 适合做为基线模型，与更复杂的时序模型（如ARIMA、Prophet等）对比。

## 代码片段说明

```python
# 计算weekday和day因子均值
purchase_weekday = summary.groupby('weekday')['total_purchase_amt'].mean()
purchase_day = summary.groupby('day')['total_purchase_amt'].mean()
# ...
# 预测值 = weekday因子 + day因子 - 历史均值
purchase_pred = purchase_weekday[wd] + purchase_day.get(daynum, purchase_mean) - purchase_mean
```

这种方式假设申购/赎回金额的周期性主要由星期几和每月几号共同决定，且两者影响可以线性叠加。

---

如需进一步分析或可视化，请补充需求！ 